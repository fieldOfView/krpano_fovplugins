/*
gyro plugin for KRPanoJS and iOS4.2+
by Aldo Hoeben / fieldOfView.com
contributions by 
	Sjeiti / ronvalstar.nl
	Klaus / krpano.com
	
http://fieldofview.github.com/krpano_fovplugins/gyro/plugin.html
This software can be used free of charge and the source code is available under a Creative Commons Attribution license:
	http://creativecommons.org/licenses/by/3.0/	
*/
var krpanoplugin=function(){var q=this,x=null,e=null,s,y=false,b=0,v=false,i=0.5,w=false,z=0,p=0,u=0,l=0,g=0,n=0,c=Math.PI/180;q.registerplugin=function(B,A,C){x=B;e=C;if(x.version<"1.0.8.14"||x.build<"2011-03-30"){x.trace(3,"gyro plugin - too old krpano version (min. 1.0.8.14)");return}if(!!window.DeviceOrientationEvent){window.addEventListener("deviceorientation",j)}e.registerattribute("available",false,function(D){},function(){return s});e.registerattribute("enabled",true,function(D){t(D)?m():d()},function(){return y});e.registerattribute("velastic",0,function(D){b=Math.max(Math.min(Number(D),1),0);x.trace(0,(1-Math.pow(b,2)))},function(){return b});e.registerattribute("camroll",false,function(D){v=t(D)},function(){return v});e.registerattribute("friction",0.5,function(D){i=Math.max(Math.min(Number(D),1),0)},function(){return i});e.enable=m;e.disable=d;e.toggle=r};q.unloadplugin=function(){window.removeEventListener("deviceorientation",j);d();e=null;x=null};function m(){if(s===undefined){y=true;return}if(s&&!y){window.addEventListener("deviceorientation",h,true);x.control.layer.addEventListener("touchstart",k,true);x.control.layer.addEventListener("touchend",o,true);x.control.layer.addEventListener("touchcancel",o,true);y=true;z=-top.orientation;p=0;u=0;l=0}else{y=false}}function d(){if(s&&y){window.removeEventListener("deviceorientation",h);x.control.layer.removeEventListener("touchstart",k);x.control.layer.removeEventListener("touchend",o);x.control.layer.removeEventListener("touchcancel",o)}y=false}function r(){if(y){d()}else{m()}}function j(A){s=true;window.removeEventListener("deviceorientation",j);if(y){y=false;m()}}function k(A){w=true}function o(A){w=false}function h(A){if(!w&&y){var C=a(new Object({yaw:A.alpha*c,pitch:A.beta*c,roll:A.gamma*c})),F=f(C.yaw/c),B=C.pitch/c,G=F,I,J=x.view.hlookat,H=x.view.vlookat,E=x.view.camroll,K=J-u,D=H-l;if(v){g=f(180+Number(top.orientation)-C.roll/c)}if(Math.abs(B)>70){G=A.alpha;switch(top.orientation){case 0:if(B>0){G+=180}break;case 90:G+=90;break;case -90:G+=-90;break;case 180:if(B<0){G+=180}break}G=f(G);if(Math.abs(G-F)>180){G+=(G<F)?360:-360}I=Math.min(1,(Math.abs(B)-70)/10);F=F*(1-I)+G*I;g*=(1-I)}z+=K;p+=D;if(Math.abs(B+p)>90){p=(B+p>0)?(90-B):(-90-B)}u=f(-F-180+z);l=Math.max(Math.min((B+p),90),-90);if(Math.abs(u-J)>180){J+=(u>J)?360:-360}u=(1-i)*u+i*J;l=(1-i)*l+i*H;if(Math.abs(g-E)>180){E+=(g>E)?360:-360}g=(1-i)*g+i*E;x.view.hlookat=f(u);x.view.vlookat=l;x.view.camroll=f(g);if(p!=0&&b>0){if(D==0){if(b==1){p=0;n=0}else{n=1-((1-n)*x.control.touchfriction);p*=1-(Math.pow(b,2)*n);if(Math.abs(p)<0.1){p=0;n=0}}}else{n=0}}}}function a(C){var J,G,B,A=Math.cos(C.yaw),F=Math.sin(C.yaw),E=Math.cos(C.pitch),I=Math.sin(C.pitch),D=Math.cos(C.roll),H=Math.sin(C.roll);matrix=new Array(F*H-A*I*D,-A*E,A*I*H+F*D,E*D,-I,-E*H,F*I*D+A*H,F*E,-F*I*H+A*D);if(matrix[3]>0.9999){J=Math.atan2(matrix[2],matrix[8]);B=Math.PI/2;G=0}else{if(matrix[3]<-0.9999){J=Math.atan2(matrix[2],matrix[8]);B=-Math.PI/2;G=0}else{J=Math.atan2(-matrix[6],matrix[0]);G=Math.atan2(-matrix[5],matrix[4]);B=Math.asin(matrix[3])}}return new Object({yaw:J,pitch:B,roll:G})}function f(A){A=A%360;return(A<=180)?A:A-360}function t(A){return(String("yesontrue1").indexOf(String(A).toLowerCase())>=0)}};
